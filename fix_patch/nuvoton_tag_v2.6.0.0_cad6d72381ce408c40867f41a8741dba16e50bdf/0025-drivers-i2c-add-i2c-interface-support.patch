From 2499d7f7ce587397d85a572167f8132f7c76979c Mon Sep 17 00:00:00 2001
From: Tyrone Ting <kfting@nuvoton.com>
Date: Thu, 24 Jul 2025 15:26:42 +0800
Subject: [PATCH 1/3] drivers: i2c: add i2c interface support

Signed-off-by: Tyrone Ting <kfting@nuvoton.com>
---
 drivers/i2c/i2c_npcm4xx.c     | 42 +++++++++++++++++++++++++++++++++++
 include/drivers/i2c_npcm4xx.h | 14 ++++++++++++
 2 files changed, 56 insertions(+)
 create mode 100644 include/drivers/i2c_npcm4xx.h

diff --git a/drivers/i2c/i2c_npcm4xx.c b/drivers/i2c/i2c_npcm4xx.c
index 0552c7821b62..575dee1d0b55 100755
--- a/drivers/i2c/i2c_npcm4xx.c
+++ b/drivers/i2c/i2c_npcm4xx.c
@@ -9,6 +9,7 @@
 #include <drivers/clock_control.h>
 #include <dt-bindings/i2c/i2c.h>
 #include <drivers/i2c.h>
+#include "drivers/i2c_npcm4xx.h"
 #include <soc.h>
 
 #include <logging/log.h>
@@ -107,6 +108,47 @@ struct i2c_npcm4xx_data {
 
 #define I2C_INSTANCE(dev) (struct i2c_reg *)(I2C_DRV_CONFIG(dev)->base)
 
+bool is_i2c_npcm_device_master_status_idle(const struct device *dev)
+{
+	if (dev == NULL) {
+		LOG_ERR("%s dev null", __func__);
+		return false;
+	}
+
+	struct i2c_npcm4xx_data *const data = I2C_DRV_DATA(dev);
+
+	return (data->master_oper_state == I2C_NPCM4XX_OPER_STA_IDLE);
+}
+
+int i2c_npcm_device_disable(const struct device *dev)
+{
+	int loop, loop_limit = 30;
+
+	if (dev == NULL) {
+		LOG_ERR("%s dev null", __func__);
+		return -EBUSY;
+	}
+
+	struct i2c_npcm4xx_data *const data = I2C_DRV_DATA(dev);
+	struct i2c_reg *const inst = I2C_INSTANCE(dev);
+
+	for (loop = 0; loop < loop_limit; loop ++) {
+		if (data->master_oper_state != I2C_NPCM4XX_OPER_STA_IDLE) {
+			k_busy_wait(1000);
+		} else {
+			inst->SMBnCTL2 &= ~BIT(NPCM4XX_SMBnCTL2_ENABLE);
+			break;
+		}
+	}
+
+	if (loop >= loop_limit) {
+		LOG_ERR("%s dev still busy!", __func__);
+		return -EBUSY;
+	}
+
+	return 0;
+}
+
 
 /* This macro should be set only when in Master mode or when requesting Master mode.
  * Set START bit to CTL1 register of I2C module, but exclude STOP bit, ACK bit.
diff --git a/include/drivers/i2c_npcm4xx.h b/include/drivers/i2c_npcm4xx.h
new file mode 100644
index 000000000000..e3265993b66e
--- /dev/null
+++ b/include/drivers/i2c_npcm4xx.h
@@ -0,0 +1,14 @@
+/*
+ * Copyright (c) 2024 Nuvoton Technology Corporation.
+ *
+ * SPDX-License-Identifier: Apache-2.0
+ */
+
+#ifndef ZEPHYR_INCLUDE_DRIVERS_I2C_NPCM4XX_H_
+#define ZEPHYR_INCLUDE_DRIVERS_I2C_NPCM4XX_H_
+
+
+bool is_i2c_npcm_device_master_status_idle(const struct device *dev);
+int i2c_npcm_device_disable(const struct device *dev);
+
+#endif
-- 
2.17.1

